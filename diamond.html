<html>
	<head>
		<title>Diamond Go</title>
	</head>
	<body>
		<script src="three.min.js"></script>
		<script src="doban.js"></script>
		<script type="text/javascript">
			var	boardSize = 13;
			var cameraDistance = 1.7;
			var pan = new THREE.Vector2();
			var azimuth = 0.0;
			var altitude = 0.0;

			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 10000);
			var renderer = new THREE.WebGLRenderer();
			self.renderer.setSize( window.innerWidth, window.innerHeight );
			self.renderer.sortObjects =false;
			document.body.appendChild(self.renderer.domElement);
			camera.position.z = cameraDistance;

			var pickingScene = new THREE.Scene();
			var pickingTexture = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight );
			var canvasRect = renderer.domElement.getBoundingClientRect();

			pickingTexture.generateMipmaps = false;

			doban = new Doban(13);
			doban.addToScene(scene);
			doban.addToPickingScene(pickingScene);
			// THREE.ImageUtils.crossOrigin ='file:///home/phooky/Repos/phooky/diamond-go/';
			// console.log(THREE.ImageUtils.crossOrigin);
			// var nodeTex = THREE.ImageUtils.loadTexture( "./node-tex.png" );
   //          var nodeSpriteMat = new THREE.SpriteMaterial( { map: nodeTex, color: 0xffffff, fog: true } );
   //          var sprite = new THREE.Sprite( nodeSpriteMat );
   //          scene.add( sprite );
			var hoverObj = undefined;
			var downOn = undefined;
			var mouse = new THREE.Vector2();

			function updateMousePosition(event) {
				event.preventDefault();
				mouse.x = event.offsetX; 
				mouse.y = event.offsetY; 
			}

			function onDocumentMouseMove( event ) {
				updateMousePosition(event);
			}


			function onDocumentMouseDown( event ) {
				updateMousePosition(event);
				downOn = hoverObj;
			}

			function onDocumentMouseUp( event ) {
				updateMousePosition(event);
				if (downOn == hoverObj) {
					nodeClicked(hoverObj);
				}
				downOn = undefined;
			}

			function onDocumentMouseWheel( event ) {
				if (event.wheelDelta > 0) {
					cameraDistance -= 0.02;
				} else {
					cameraDistance += 0.02;
				}
			}

			function nodeClicked( node ) {
				if (node.state != NODE_EMPTY) return;
				doban.playStone(node);
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				self.renderer.setSize( window.innerWidth, window.innerHeight );
				pickingTexture = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight );
				canvasRect = renderer.domElement.getBoundingClientRect();
			}

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			document.addEventListener( 'mousedown', onDocumentMouseDown, false );
			document.addEventListener( 'mouseup', onDocumentMouseUp, false );
			document.addEventListener( 'mousewheel', onDocumentMouseWheel, false );
			window.addEventListener( 'resize', onWindowResize, false );

			function pick() {
				//render the picking scene off-screen
				self.renderer.render( pickingScene, camera, pickingTexture );
				var gl = self.renderer.getContext();
				//read the pixel under the mouse from the texture
				var pixelBuffer = new Uint8Array( 4 );
				gl.readPixels( mouse.x, window.innerHeight - mouse.y, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, pixelBuffer );
				//interpret the pixel as an ID
				var id = ( pixelBuffer[0] << 16 ) | ( pixelBuffer[1] << 8 ) | ( pixelBuffer[2] );
				if (hoverObj) { hoverObj.mesh.material = hoverObj.getMaterial(false); }
					//console.log("Id is",id);
				if (id != 0) {
					hoverObj = doban.nodelist[id-1000];
					//console.log("selected ",id-1000);
					hoverObj.mesh.material=hoverObj.getMaterial(true);
				}

			}




			function render() {
				requestAnimationFrame( render );

				pick();

				var a = Math.cos(altitude) * cameraDistance;
				camera.position.z = Math.cos(azimuth)*a;
				camera.position.x = Math.sin(azimuth)*a;
				camera.position.y = Math.sin(altitude)*cameraDistance;
				camera.lookAt(new THREE.Vector3(0,0,0));
				self.renderer.render( scene, camera );
			}
			render();
		</script>
	</body>
</html>