<html>
	<head>
		<title>Diamond Go</title>
	</head>
	<body>
		<script src="three.min.js"></script>
		<script src="doban.js"></script>
		<script type="text/javascript">
			var	boardSize = 13;
			var cameraDistance = 1.7;

			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 10000);
			var renderer = new THREE.WebGLRenderer();
			self.renderer.setSize( window.innerWidth, window.innerHeight );
			self.renderer.sortObjects =false;
			document.body.appendChild(self.renderer.domElement);
			camera.position.z = cameraDistance;

			var pickingScene = new THREE.Scene();
			var pickingTexture = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight );
			var canvasRect = renderer.domElement.getBoundingClientRect();

			pickingTexture.generateMipmaps = false;

			var linesGeo = new THREE.Geometry();
			var makeMesh = function(node,ranks) {
					var mesh = new THREE.Mesh(nodeGeo,nodeMat);
					mesh.position.y = (ranks/2 - node.rank) * rankHeight;
					mesh.position.x = node.x * rankDiag;
					mesh.position.z = node.y * rankDiag;
					node.mesh = mesh;
					mesh.node = node;
					scene.add(mesh);

					var pickMat = new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors});
					pickMat.blending = 0;
					var pickMesh = new THREE.Mesh(nodeGeo.clone(), pickMat);
					pickMesh.geometry.faces.forEach( function( f ) {
						var n = ( f instanceof THREE.Face3 ) ? 3 : 4;
						for( var j = 0; j < n; j ++ ) {
							f.vertexColors[ j ] = new THREE.Color(node.index+1000);
						}
					} );
					pickMesh.position.y = (ranks/2 - node.rank) * rankHeight;
					pickMesh.position.x = node.x * rankDiag;
					pickMesh.position.z = node.y * rankDiag;
					pickingScene.add(pickMesh);
			}

			var rankHeight = 0.1;
			var rankDiag = rankHeight * Math.sqrt(2);
			var nodeMat = new THREE.MeshBasicMaterial({color:0x00ff00});
			var nodeSelMat = new THREE.MeshBasicMaterial({color:0x0000ff});
			var nodeGeo = new THREE.BoxGeometry(0.04,0.04,0.04);
			var linkMat = new THREE.LineBasicMaterial( { color: 0x777777, opacity: 1, linewidth: 3 } );
			var linesMesh = new THREE.Line(linesGeo,linkMat,THREE.LinePieces);
			scene.add(linesMesh);
			// THREE.ImageUtils.crossOrigin ='file:///home/phooky/Repos/phooky/diamond-go/';
			// console.log(THREE.ImageUtils.crossOrigin);
			// var nodeTex = THREE.ImageUtils.loadTexture( "./node-tex.png" );
   //          var nodeSpriteMat = new THREE.SpriteMaterial( { map: nodeTex, color: 0xffffff, fog: true } );
   //          var sprite = new THREE.Sprite( nodeSpriteMat );
   //          scene.add( sprite );

			doban = new Doban(13);
			for (var i = 0; i < doban.nodelist.length; i++) {
				var n = doban.nodelist[i];
				makeMesh(doban.nodelist[i],doban.ranks);
			}

			for (var j = 0; j < doban.nodelist.length; j++) {
				var node = doban.nodelist[j];
				for (var i = 0; i < node.links.length; i++) {
					var n = node.links[i];
					if (n.rank > node.rank) {
						linesGeo.vertices.push(node.mesh.position);
						linesGeo.vertices.push(n.mesh.position);
					}
				}
			}

			var hoverObj = undefined;
			var mouse = new THREE.Vector2();

			function onDocumentMouseMove( event ) {
				event.preventDefault();
				mouse.x = event.clientX - canvasRect.left; // ( event.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = event.clientY - canvasRect.top; //- ( event.clientY / window.innerHeight ) * 2 + 1;
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				self.renderer.setSize( window.innerWidth, window.innerHeight );
				pickingTexture = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight );
				canvasRect = renderer.domElement.getBoundingClientRect();
			}

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			window.addEventListener( 'resize', onWindowResize, false );

			function pick() {
				//render the picking scene off-screen
				self.renderer.render( pickingScene, camera, pickingTexture );
				var gl = self.renderer.getContext();
				//read the pixel under the mouse from the texture
				var pixelBuffer = new Uint8Array( 4 );
				gl.readPixels( mouse.x, window.innerHeight - mouse.y, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, pixelBuffer );
				//interpret the pixel as an ID
				var id = ( pixelBuffer[0] << 16 ) | ( pixelBuffer[1] << 8 ) | ( pixelBuffer[2] );
				if (hoverObj) { hoverObj.mesh.material = nodeMat; }
					//console.log("Id is",id);
				if (id != 0) {
					hoverObj = doban.nodelist[id-1000];
					//console.log("selected ",id-1000);
					hoverObj.mesh.material=nodeSelMat;
				}

			}




			function render() {
				requestAnimationFrame( render );

				pick();

				var angle=new Date().getTime()/7200.0;
				camera.position.z = Math.cos(angle)*cameraDistance;
				camera.position.x = Math.sin(angle)*cameraDistance;
				camera.lookAt(new THREE.Vector3(0,0,0));
				self.renderer.render( scene, camera );
			}
			render();
		</script>
	</body>
</html>